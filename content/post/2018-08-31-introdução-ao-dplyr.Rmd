---
title: Introdução ao dplyr
author: dadosaleatorios
date: '2018-08-31'
slug: introdução-ao-dplyr
categories:
  - analise de dados
  - data science
  - estatistica
  - iniciantes
  - linguagem R
---

## O que é o dplyr e por que usá-lo?

[`dplyr`](https://dplyr.tidyverse.org/) é um pacote do R para manipulação de dados, sendo um dos pacotes que forma o núcleo do [`tidyverse`](https://www.tidyverse.org/). Se você nunca ouviu falar no `tidyverse`, ele é basicamente um pacote de pacotes que tem uma filosofia em comum, sendo cada pacote especializado em um tipo de tarefa, com a intenção de integrar todos eles facilmente em nosso script. O `dplyr` tem como base poucos verbos que resolvem boa parte dos problemas envolvendo manipulação de dados.

Um outro ponto é que o `dplyr` permite que nós façamos um código facilmente legível e compreensível, justamente pelo fato de usar verbos e também de permitir o encadeamento, que faz com que a sequência do código seja mais próxima da maneira com que pensamos. Além disso, o pacote é bem rápido, ainda que não seja tão rápido quanto o `data.table` (que não tem uma sintaxe simples de utilização).

As funções do `dplyr` podem ser utilizadas para manipular tabelas do SQL, sem importar a tabela para o R (utilizando lazy query), mas isso é assunto para um post futuro. Existe também uma comunidade grande de programadores do R que utilizam o pacote.

## Instalação

Temos duas opções: Podemos instalar apenas o dplyr ou todo o tidyverse (recomendado):

```{r eval = F}
install.packages("tidyverse")

require(tidyerse)
```

```{r echo = F, message=FALSE, warning=FALSE}
require(tidyverse)
```

## Dados

Neste post vamos apresentar as principais funções do pacote com exemplos, e para isso utilizaremos o dataset `starwars`, que pode ser utilizado ao ativar o `dplyr`. O dataset tem informações sobre personagens da saga, que foram coletados de uma [API de Star Wars](http://swapi.co/). Vamos dar uma olhada no dataset:

```{r}
starwars
```

Já podemos ver que não estamos lidando com um `data.frame` tradicional. Este é um `tibble`, que é, basicamente, um data.frame com uma série de modificações. A propósito, [`tibble`](https://tibble.tidyverse.org/) é outro pacote do `tidyverse`. Note que são mostradas as quantidades de linhas e colunas, apenas as 10 primeiras linhas são printadas, a classe das colunas é indicada, e, caso haja coluna(s) cujo conteúdo exceda o tamanho da janela, elas não são printadas, mas apenas listadas ao final.

Nesse `tibble` temos então, para 87 personagens de Star Wars, informações de nome, altura, massa, cor de cabelo, pele, dos olhos, idade na batalha de Yavin (quando os rebeldes destruíram a primeira estrela da morte), gênero, mundo natal, espécie, lista de filmes onde o personagem aparece, lista de veículos que o personagem pilotou e lista de naves que o personagem pilotou. Perceba que usei a palavra 'lista' nessas três ultimas informações, isso porque essas colunas são realmente listas. Podemos, então, ter um `tibble` onde colunas são listas.

Também podemos utilizar a função `glimpse`, do pacote `tibble`, para visualizar a tabela de outra maneira. A função é carregada ao ativar o `dplyr`. Observe que o `glimpse` também mostra o número de linhas e colunas, além de mostrar a classe das colunas e alguns valores dessas colunas.

```{r}
glimpse(starwars)
```

Apesar de a concepção de `data.frame` do `tidyverse` ser o `tibble`, é perfeitamente possível utilizar suas funções com um `data.frame`. Para, porém, transformar um `data.frame` em um `tibble`, basta usar a função `as_tibble` (ou `as_data_frame`).

## Funções básicas (verbos)

O `dplyr` oferece 5 verbos (funções) básicos, que resolvem alguns problemas comuns:

- `select`: Seleciona colunas.
- `filter`: Filtra registros (linhas).
- `mutate`: Cria novas variáveis (colunas).
- `summarise` (ou `summarize`): Reduz uma série de valores de uma coluna em um valor apenas.
- `arrange`: Ordena o `data.frame` de acordo com os valores de uma(s) coluna(s).

Além disso, existe a função `group_by`, que pode ser usada em conjunto com os verbos, de maneira a fazer operações por grupos de valores de coluna(s).

Todas essas funções recebem pelo menos dois argumentos: o `data.frame` e o(s) argumento(s) pertinente(s) à função (nomes de colunas, funções, condições). A seguir vamos utilizar as funções para ficar mais clara sua sintaxe.

## Uso

- O `select` seleciona colunas, podendo ser indicadas pelos nomes (com ou sem aspas, embora seja preferível não usar aspas) ou pelo índice da coluna. Por exemplo, se quisermos selecionar as colunas `name`, `height` e `mass`, podemos selecioná-las das seguintes maneiras:

```{r eval = F}
select(starwars, name, height, mass)
# ou
select(starwars, "name", "height", "mass")
# Ou, como as colunas são seguidas
select(starwars, name:mass)
# Utilizando os índices
select(starwars, 1:3)
```

Gerando o seguinte output:

```{r echo = F}
select(starwars, name:mass)
```

Também podemos remover colunas. Por exemplo, queremos selecionar todas as colunas do nosso `tibble`, exceto a coluna `height`:

```{r}
select(starwars, -height)
```

- A função `filter` recebe uma condição (ou mais de uma condição) e retorna as linhas do `tibble` que atendam a essa condição. Vamos filtrar personagens que não têm cabelo, logo `hair_color` é `NA`:

```{r}
filter(starwars, is.na(hair_color))
```

    Podemos também utilizar mais de uma condição (usando & ou |). Caso queiramos registros que atendam a todas as condições, podemos utilizar & (E) ou separar as condições por vírgulas. Caso queiramos registros que atendam a pelo menos uma condição, devemos utilizar o operador | (OU). Vamos agora filtrar personagens sem cabelo e Droids:
    
    ```{r}
    filter(starwars, is.na(hair_color), species == "Droid")
    ```
    
Vamos agora filtrar por personagens com mais de 130 kg e selecionar `name`, `height`, `mass` e `homeworld`:

```{r}
select(filter(starwars, mass > 130), name:mass, homeworld)
```

Apesar de termos só duas funções envolvidas, veja que começa a não ser tão simples de ler o que o R irá fazer com esse comando. Quando o número de funções aumenta, isso fica bem pior de ler. Para resolver esse problema, o `tidyverse` propõe uma maneira de encadear o código:

- **pipe** (`%>%`): O **pipe** é o operador que faz o encadeamento das funções do `tidyverse`. Este operador é do pacote [`magrittr`](https://magrittr.tidyverse.org/), mas ao carregar o `dplyr` já poderemos usá-lo. Seu atalho, no RStudio, é *Ctrl + Shift + M*. O *pipe* irá pegar o resultado da expressão a sua esquerda e colocar como primeiro argumento (por default) da expressão da direita. Como as funções do `dplyr` recebem um `tibble` no primeiro argumento, então isso vai facilitar a escrita. Vejamos o exemplo anterior com o pipe:

```{r}
starwars %>% 
  filter(mass > 130) %>% 
  select(name:mass, homeworld)
```

Perceba que agora o código fica muito mais simples de entender: Pegamos o `tibble` stawars, filtramos personagens com mais de 130 kg e do `tibble` resultante do filtro selecionamos as colunas desejadas.